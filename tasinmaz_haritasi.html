<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network - Kurum TaÅŸÄ±nmazlarÄ± AÄŸÄ±</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        /* ... (Stillerin tamamÄ± Ã¶ncekiyle aynÄ±) ... */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .header { position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1; max-width: 350px; }
        .header h1 { margin: 0 0 10px 0; font-size: 24px; color: #e74c3c; }
        .header .day { display: inline-block; background: #e74c3c; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        .header p { margin: 5px 0; font-size: 14px; color: #555; line-height: 1.5; }
        .stats { position: absolute; bottom: 20px; left: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1; font-size: 14px; }
        .stats-row { display: flex; justify-content: space-between; margin: 5px 0; gap: 20px; }
        .stats-label { color: #666; font-weight: 500; }
        .stats-value { color: #e74c3c; font-weight: bold; font-size: 16px; }
        .legend { position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1; font-size: 13px; max-width: 280px; }
        .legend h3 { margin: 0 0 10px 0; font-size: 14px; color: #333; border-bottom: 2px solid #e74c3c; padding-bottom: 5px; }
        .legend-item { display: flex; align-items: center; margin: 8px 0; }
        .legend-color { width: 15px; height: 15px; margin-right: 10px; border-radius: 50%; border: 1px solid #777; } /* === GÃœNCEL STÄ°L (Daire) === */
        .legend-label { color: #666; }
        .controls { position: absolute; bottom: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1; max-width: 240px; max-height: 80vh; overflow-y: auto; }
        .control-group { margin: 10px 0; }
        .control-label { font-size: 12px; color: #666; margin-bottom: 5px; display: block; }
        input[type="range"] { width: 100%; }
        select { width: 100%; padding: 8px 5px; border-radius: 5px; border: 1px solid #ccc; background-color: white; font-size: 13px; }
        select:disabled { background-color: #f0f0f0; color: #999; }
        .control-value { display: inline-block; margin-left: 10px; font-weight: bold; color: #e74c3c; min-width: 40px; }
        button { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; margin: 5px 0; width: 100%; }
        button:hover { background: #c0392b; }
        #clearFiltersButton { background-color: #7f8c8d; }
        #clearFiltersButton:hover { background-color: #6c7a7d; }
        .maplibregl-popup-content { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-shadow: 0 2px 10px rgba(0,0,0,0.15); border-radius: 8px; padding: 12px; }
        .popup-container { min-width: 220px; max-height: 250px; overflow-y: auto; font-size: 13px; }
        .popup-container strong { color: #333; font-size: 12px; }
        .popup-container hr { border: none; height: 1px; background: #eee; margin: 6px 0; }
        .popup-title { font-size: 16px; font-weight: 600; color: #e74c3c; margin-bottom: 5px; }
        input[type="text"] { width: 100%; padding: 8px 5px; border-radius: 5px; border: 1px solid #ccc; background-color: white; font-size: 13px; box-sizing: border-box; }
        .search-container { display: flex; gap: 5px; }
        .search-container input { width: 100%; flex-grow: 1; }
        .search-container button { width: auto; margin: 0; padding: 8px 10px; flex-shrink: 0; }
        .ada-parsel-container { display: flex; gap: 5px; }
        .ada-parsel-container input { width: 50%; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="header"> ... (iÃ§erik aynÄ±) ... </div>
    <div class="stats"> ... (iÃ§erik aynÄ±) ... </div>
    <div class="header">
        <div class="day">AÅAMA 5</div>
        <h1>TaÅŸÄ±nmaz AÄŸÄ± HaritasÄ±</h1>
        <p>Kurumun <strong>~7,000</strong> taÅŸÄ±nmaz noktasÄ± arasÄ±ndaki baÄŸlantÄ± aÄŸÄ±.</p>
        <p style="font-size: 12px; color: #888; margin-top: 10px;">
            ğŸ–±ï¸ Harita Ã¼zerinde gezinin - mouse konumuna gÃ¶re taÅŸÄ±nmazlar arasÄ± Ã¶rÃ¼mcek aÄŸÄ± oluÅŸur.
        </p>
        <p style="font-size: 11px; color: #999; margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px;">
            <strong>Veri KaynaÄŸÄ±:</strong><br>
            Kurum TaÅŸÄ±nmazlarÄ± Verisi (GeoJSON)
        </p>
    </div>
    <div class="stats">
        <div class="stats-row">
            <span class="stats-label">Aktif BaÄŸlantÄ±:</span>
            <span class="stats-value" id="connectionCount">0</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">En YakÄ±n TaÅŸÄ±nmaz:</span>
            <span class="stats-value" id="nearestDistance">-</span>
        </div>
    </div>

    <div class="legend">
        <h3>TaÅŸÄ±nmaz Grubu</h3>
        <div class="legend-item"><div class="legend-color" style="background: #E74C3C;"></div><span class="legend-label">KONUT</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #2ECC71;"></div><span class="legend-label">ARSA</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #F39C12;"></div><span class="legend-label">TARLA</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #3498DB;"></div><span class="legend-label">Ä°ÅYERÄ°</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #9B59B6;"></div><span class="legend-label">DÄ°ÄER</span></div>
        
        <h3 style="margin-top: 15px;">BaÄŸlantÄ± Mesafesi</h3>
        <div class="legend-item"><div class="legend-color" style="background: #27ae60; opacity: 0.9; height: 3px; border: none;"></div><span class="legend-label">0-500m</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #f39c12; opacity: 0.8; height: 3px; border: none;"></div><span class="legend-label">500m-1km</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #e67e22; opacity: 0.7; height: 3px; border: none;"></div><span class="legend-label">1-2km</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #e74c3c; opacity: 0.5; height: 3px; border: none;"></div><span class="legend-label">2-3km</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #c0392b; opacity: 0.3; height: 3px; border: none;"></div><span class="legend-label">3km+</span></div>
    </div>

    <div class="controls"> ... (iÃ§erik aynÄ±) ... </div>
    <div class="controls">
        <div class="control-group">
            <label class="control-label">Tapu Sicil ile Ara</label>
            <div class="search-container">
                <input type="text" id="tapuInput" placeholder="Tapu Sicil No...">
                <button id="tapuSearchButton">Ara</button>
            </div>
        </div>
        <div class="control-group">
            <label class="control-label">Ada / Parsel ile Ara</label>
            <div class="ada-parsel-container">
                <input type="text" id="adaInput" placeholder="Ada No...">
                <input type="text" id="parselInput" placeholder="Parsel No...">
            </div>
            <button id="adaParselSearchButton" style="margin-top: 5px;">Ara</button>
        </div>
        <div class="control-group" style="border-top: 1px solid #eee; padding-top: 10px;">
            <label class="control-label">TaÅŸÄ±nmaz Grubu Filtresi</label>
            <select id="filterGroupSelect">
                <option value="TÃœMÃœ">TÃœMÃœ GÃ–STER</option>
                <option value="ARSA">ARSA</option>
                <option value="TARLA">TARLA</option>
                <option value="KONUT">KONUT</option>
                <option value="Ä°ÅYERÄ°">Ä°ÅYERÄ°</option>
                <option value="DÄ°ÄER">DÄ°ÄER</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">Ä°l Filtresi</label>
            <select id="ilFilter">
                <option value="TÃœMÃœ">TÃœM Ä°LLER</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">Ä°lÃ§e Filtresi</label>
            <select id="ilceFilter" disabled>
                <option value="TÃœMÃœ">TÃœM Ä°LÃ‡ELER</option>
            </select>
        </div>
        <div class="control-group" style="border-top: 1px solid #eee; padding-top: 10px;">
             <button id="clearFiltersButton">Arama/Filtreleri Temizle</button>
        </div>
        <div class="control-group">
            <label class="control-label">Maksimum Mesafe</label>
            <input type="range" id="maxDistance" min="500" max="5000" step="100" value="3000">
            <span class="control-value" id="maxDistanceValue">3000m</span>
        </div>
        <div class="control-group">
            <label class="control-label">Maksimum TaÅŸÄ±nmaz</label>
            <input type="range" id="maxConnections" min="10" max="200" step="10" value="50">
            <span class="control-value" id="maxConnectionsValue">50</span>
        </div>
        <button id="toggleAnimation">Animasyonu Durdur</button>
    </div>

    <script>
        // SÄ±nÄ±flandÄ±rma Fonksiyonu (DeÄŸiÅŸiklik yok)
        function getFiltreGrubu(nitelik) {
            if (!nitelik) { return 'DÄ°ÄER'; }
            if (nitelik === 'ARSA') { return 'ARSA'; }
            if (nitelik === 'TARLA') { return 'TARLA'; }
            const konutGrubu = ['GELENEKSEL APARTMAN', 'GELENEKSEL DAÄ°RE', 'MÃœSTAKÄ°L KONUT'];
            if (konutGrubu.includes(nitelik)) { return 'KONUT'; }
            const isyeriGrubu = ['DÃœKKAN/MAÄAZA', 'Ä°ÅYERÄ°/BÃœRO', 'Ä°Å MERKEZÄ°/Ä°Å HANI'];
            if (isyeriGrubu.includes(nitelik)) { return 'Ä°ÅYERÄ°'; }
            return 'DÄ°ÄER';
        }
        
        // Global DeÄŸiÅŸkenler (DeÄŸiÅŸiklik yok)
        const TURKIYE_VIEW = { center: [35.0000, 39.0000], zoom: 6 };
        let currentPopup = null; 
        let ilceMap = new Map(); 
        let ilBboxMap = new Map(); 

        // Initialize map
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: { 'carto-light': { type: 'raster', tiles: ['https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'], tileSize: 256, attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' } },
                layers: [{ id: 'carto-light-layer', type: 'raster', source: 'carto-light', minzoom: 0, maxzoom: 22 }]
            },
            center: TURKIYE_VIEW.center, 
            zoom: TURKIYE_VIEW.zoom,
            pitch: 0
        });

        let allPoints = [];
        let filteredPoints = [];
        let mousePosition = null;
        let animationEnabled = true;
        let maxDistance = 3000;
        let maxConnections = 50;

        // Veri YÃ¼kleme (BBOX hesaplama vb. deÄŸiÅŸiklik yok)
        fetch('kurum_tasinmazlari.geojson')
            .then(response => response.json())
            .then(data => {
                const ilSelect = document.getElementById('ilFilter');
                const iller = new Set(); 
                data.features.forEach(feature => {
                    const nitelik = feature.properties['KullanÄ±m_NiteliÄŸi_TanÄ±mÄ±'];
                    feature.properties.FiltreGrubu = getFiltreGrubu(nitelik);
                    const il = feature.properties['Ä°l_AdÄ±'];
                    const ilce = feature.properties['Ä°lÃ§e_AdÄ±'];
                    const coords = feature.geometry.coordinates;
                    if (il) {
                        iller.add(il.trim()); 
                        if (ilce) {
                            if (!ilceMap.has(il)) { ilceMap.set(il, new Set()); }
                            ilceMap.get(il).add(ilce.trim());
                        }
                        if (!ilBboxMap.has(il)) {
                            ilBboxMap.set(il, [coords[0], coords[1], coords[0], coords[1]]);
                        } else {
                            const bbox = ilBboxMap.get(il);
                            bbox[0] = Math.min(bbox[0], coords[0]); bbox[1] = Math.min(bbox[1], coords[1]);
                            bbox[2] = Math.max(bbox[2], coords[0]); bbox[3] = Math.max(bbox[3], coords[1]);
                            ilBboxMap.set(il, bbox);
                        }
                    }
                });
                const sortedIller = [...iller].sort((a, b) => a.localeCompare(b, 'tr'));
                sortedIller.forEach(il => {
                    const option = document.createElement('option');
                    option.value = il; option.textContent = il;
                    ilSelect.appendChild(option);
                });
                allPoints = data.features;
                filteredPoints = data.features;
                console.log(`Loaded ${allPoints.length} points.`);
                
                map.on('load', () => {
                    map.addSource('tasinmazlar', { type: 'geojson', data: data });

                    // === GELÄ°ÅTÄ°RME 5: RENKLENDÄ°RME GÃœNCELLENDÄ° ===
                    // Nokta katmanÄ± (TaÅŸÄ±nmazlar)
                    map.addLayer({
                        id: 'tasinmazlar-layer', 
                        type: 'circle', 
                        source: 'tasinmazlar',
                        paint: {
                            // 'circle-color' artÄ±k statik bir renk deÄŸil,
                            // 'FiltreGrubu' Ã¶zelliÄŸine gÃ¶re dinamik bir renktir.
                            'circle-color': [
                                'match',
                                ['get', 'FiltreGrubu'],
                                'KONUT', '#E74C3C',   // KÄ±rmÄ±zÄ±
                                'ARSA', '#2ECC71',    // YeÅŸil
                                'TARLA', '#F39C12',   // Turuncu
                                'Ä°ÅYERÄ°', '#3498DB',  // Mavi
                                'DÄ°ÄER', '#9B59B6',   // Mor
                                '#95A5A6' // EÅŸleÅŸmeyenler (varsayÄ±lan)
                            ],
                            'circle-radius': 4, // NoktalarÄ± biraz bÃ¼yÃ¼ttÃ¼m
                            'circle-opacity': 0.8,
                            'circle-stroke-width': 1,
                            'circle-stroke-color': '#ffffff'
                        }
                    });

                    // === GELÄ°ÅTÄ°RME 6: PARSEL KATMANI EKLENDÄ° ===
                    // (Bu kodun Ã§alÄ±ÅŸmasÄ± iÃ§in 'parseller.geojson' dosyasÄ±nÄ±n
                    // 'tasinmaz_haritasi.html' ile aynÄ± klasÃ¶rde olmasÄ± gerekir)
                    fetch('parseller.geojson')
                        .then(response => response.json())
                        .then(parselData => {
                            console.log(`Loaded ${parselData.features.length} parcels.`);
                            map.addSource('parseller-source', {
                                type: 'geojson',
                                data: parselData
                            });
                            
                            // Parsel katmanÄ±nÄ±, 'tasinmazlar-layer'Ä±n ALTINA ekle
                            // BÃ¶ylece noktalar parsellerin Ã¼stÃ¼nde gÃ¶rÃ¼nÃ¼r
                            map.addLayer({
                                id: 'parseller-layer',
                                type: 'fill',
                                source: 'parseller-source',
                                paint: {
                                    'fill-color': '#95A5A6', // Gri (veya baÅŸka bir renk)
                                    'fill-opacity': 0.3,
                                    'fill-outline-color': '#000000'
                                }
                            }, 'tasinmazlar-layer'); // Bu 'beforeId' Ã¶nemlidir!
                        
                        }).catch(err => {
                            console.warn('Parsel verisi yÃ¼klenemedi (parseller.geojson bulunamadÄ± mÄ±?):', err);
                        });
                    // === GELÄ°ÅTÄ°RME 6 BÄ°TTÄ° ===

                    map.addSource('spider-lines', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
                    map.addLayer({ id: 'spider-lines-layer', type: 'line', source: 'spider-lines', paint: { 'line-width': ['get', 'width'], 'line-color': ['get', 'color'], 'line-opacity': ['get', 'opacity'] } });
                    map.addSource('mouse-point', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
                    map.addLayer({ id: 'mouse-point-layer', type: 'circle', source: 'mouse-point', paint: { 'circle-radius': 8, 'circle-color': '#e74c3c', 'circle-opacity': 0.8, 'circle-stroke-width': 2, 'circle-stroke-color': '#ffffff', 'circle-stroke-opacity': 1 } });
                });
            });

        // calculateDistance ve getColorForDistance (DeÄŸiÅŸiklik yok)
        function calculateDistance(lon1, lat1, lon2, lat2) { const R = 6371e3; const Ï†1 = lat1 * Math.PI / 180; const Ï†2 = lat2 * Math.PI / 180; const Î”Ï† = (lat2 - lat1) * Math.PI / 180; const Î”Î» = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; }
        function getColorForDistance(distance) { if (distance < 500) return { color: '#27ae60', opacity: 0.9, width: 2.5 }; if (distance < 1000) return { color: '#f39c12', opacity: 0.8, width: 2.0 }; if (distance < 2000) return { color: '#e67e22', opacity: 0.7, width: 1.5 }; if (distance < 3000) return { color: '#e74c3c', opacity: 0.5, width: 1.2 }; return { color: '#c0392b', opacity: 0.3, width: 1.0 }; }

        // updateSpider (DeÄŸiÅŸiklik yok)
        function updateSpider(lngLat) {
            if (!map.getSource('spider-lines')) return; 
            if (filteredPoints.length === 0) {
                document.getElementById('connectionCount').textContent = '0';
                document.getElementById('nearestDistance').textContent = '-';
                map.getSource('spider-lines').setData({ type: 'FeatureCollection', features: [] });
                return;
            }
            const mouseLon = lngLat.lng; const mouseLat = lngLat.lat; 
            const pointsWithDistance = filteredPoints.map(point => {
                const [lon, lat] = point.geometry.coordinates;
                const distance = calculateDistance(mouseLon, mouseLat, lon, lat);
                return { point, distance }; 
            });
            const nearestPoints = pointsWithDistance.filter(item => item.distance <= maxDistance).sort((a, b) => a.distance - b.distance).slice(0, maxConnections);
            document.getElementById('connectionCount').textContent = nearestPoints.length;
            if (nearestPoints.length > 0) {
                const nearest = nearestPoints[0].distance;
                document.getElementById('nearestDistance').textContent = nearest < 1000 ? `${Math.round(nearest)}m` : `${(nearest/1000).toFixed(2)}km`;
            } else { document.getElementById('nearestDistance').textContent = '-'; }
            const lineFeatures = nearestPoints.map(item => {
                const [lon, lat] = item.point.geometry.coordinates; const style = getColorForDistance(item.distance);
                return { type: 'Feature', properties: { distance: item.distance, color: style.color, opacity: style.opacity, width: style.width }, geometry: { type: 'LineString', coordinates: [ [mouseLon, mouseLat], [lon, lat] ] } };
            });
            map.getSource('spider-lines').setData({ type: 'FeatureCollection', features: lineFeatures });
            map.getSource('mouse-point').setData({ type: 'FeatureCollection', features: [{ type: 'Feature', geometry: { type: 'Point', coordinates: [mouseLon, mouseLat] } }] });
        }

        // Mouse move handler (DeÄŸiÅŸiklik yok)
        map.on('mousemove', (e) => {
            if (animationEnabled) { mousePosition = e.lngLat; updateSpider(e.lngLat); }
        });
        map.on('mouseleave', () => {
            if (map.getSource('spider-lines')) { map.getSource('spider-lines').setData({ type: 'FeatureCollection', features: [] }); }
            if (map.getSource('mouse-point')) { map.getSource('mouse-point').setData({ type: 'FeatureCollection', features: [] }); }
            document.getElementById('connectionCount').textContent = '0';
            document.getElementById('nearestDistance').textContent = '-';
        });

        // Controls (KaydÄ±raÃ§lar) (DeÄŸiÅŸiklik yok)
        document.getElementById('maxDistance').addEventListener('input', (e) => {
            maxDistance = parseInt(e.target.value);
            document.getElementById('maxDistanceValue').textContent = `${maxDistance}m`;
            if (mousePosition && animationEnabled) { updateSpider(mousePosition); }
        });
        document.getElementById('maxConnections').addEventListener('input', (e) => {
            maxConnections = parseInt(e.target.value);
            document.getElementById('maxConnectionsValue').textContent = maxConnections;
            if (mousePosition && animationEnabled) { updateSpider(mousePosition); }
        });
        document.getElementById('toggleAnimation').addEventListener('click', () => {
            animationEnabled = !animationEnabled;
            const btn = document.getElementById('toggleAnimation');
            btn.textContent = animationEnabled ? 'Animasyonu Durdur' : 'Animasyonu BaÅŸlat';
            if (!animationEnabled) {
                map.getSource('spider-lines').setData({ type: 'FeatureCollection', features: [] });
                map.getSource('mouse-point').setData({ type: 'FeatureCollection', features: [] });
            } else if (mousePosition) { updateSpider(mousePosition); }
        });

        // Filtreleme FonksiyonlarÄ± (DeÄŸiÅŸiklik yok)
        function applyAllFilters() {
            const grup = document.getElementById('filterGroupSelect').value;
            const il = document.getElementById('ilFilter').value;
            const ilce = document.getElementById('ilceFilter').value;
            let mapFilter = ['all']; 
            filteredPoints = allPoints.filter(feature => {
                const props = feature.properties;
                let grupMatch = (grup === 'TÃœMÃœ') || (props.FiltreGrubu === grup);
                let ilMatch = (il === 'TÃœMÃœ') || (props['Ä°l_AdÄ±'] === il);
                let ilceMatch = (ilce === 'TÃœMÃœ') || (props['Ä°lÃ§e_AdÄ±'] === ilce);
                return grupMatch && ilMatch && ilceMatch;
            });
            if (grup !== 'TÃœMÃœ') { mapFilter.push(['==', ['get', 'FiltreGrubu'], grup]); }
            if (il !== 'TÃœMÃœ') { mapFilter.push(['==', ['get', 'Ä°l_AdÄ±'], il]); }
            if (ilce !== 'TÃœMÃœ') { mapFilter.push(['==', ['get', 'Ä°lÃ§e_AdÄ±'], ilce]); }
            map.setFilter('tasinmazlar-layer', mapFilter.length > 1 ? mapFilter : null);
            
            // === GELÄ°ÅTÄ°RME 6: PARSEL FÄ°LTRESÄ° ===
            // Noktalar filtrelendiÄŸinde, parselleri de filtrele
            // (Bu kod, 'parseller-layer' katmanÄ±nÄ±n yÃ¼klendiÄŸini varsayar)
            if (map.getLayer('parseller-layer')) {
                map.setFilter('parseller-layer', mapFilter.length > 1 ? mapFilter : null);
            }
            // === BÄ°TTÄ° ===

            if (mousePosition && animationEnabled) {
                updateSpider(mousePosition);
            }
        }
        function updateIlceFilter() {
            const selectedIl = document.getElementById('ilFilter').value;
            const ilceSelect = document.getElementById('ilceFilter');
            ilceSelect.innerHTML = '<option value="TÃœMÃœ">TÃœM Ä°LÃ‡ELER</option>'; 
            if (selectedIl === 'TÃœMÃœ') {
                ilceSelect.disabled = true; 
            } else {
                ilceSelect.disabled = false; 
                const ilceler = ilceMap.get(selectedIl);
                if (ilceler) {
                    const sortedIlceler = [...ilceler].sort((a, b) => a.localeCompare(b, 'tr'));
                    sortedIlceler.forEach(ilce => {
                        const option = document.createElement('option');
                        option.value = ilce; option.textContent = ilce;
                        ilceSelect.appendChild(option);
                    });
                }
            }
        }
        function clearAll() {
            document.getElementById('tapuInput').value = '';
            document.getElementById('adaInput').value = '';
            document.getElementById('parselInput').value = '';
            document.getElementById('filterGroupSelect').value = 'TÃœMÃœ';
            document.getElementById('ilFilter').value = 'TÃœMÃœ';
            updateIlceFilter(); 
            applyAllFilters(); 
            if (currentPopup) {
                currentPopup.remove();
                currentPopup = null;
            }
            resetView(); 
        }

        // Filtre Dinleyicileri (DeÄŸiÅŸiklik yok)
        document.getElementById('filterGroupSelect').addEventListener('change', applyAllFilters);
        document.getElementById('ilFilter').addEventListener('change', () => {
            updateIlceFilter(); 
            applyAllFilters();  
            const selectedIl = document.getElementById('ilFilter').value;
            if (selectedIl === 'TÃœMÃœ') {
                resetView(); 
            } else {
                const bbox = ilBboxMap.get(selectedIl);
                if (bbox) {
                    if (bbox[0] === bbox[2] && bbox[1] === bbox[3]) {
                        map.flyTo({ center: [bbox[0], bbox[1]], zoom: 15 });
                    } else {
                        map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], {
                            padding: 50 
                        });
                    }
                }
            }
        });
        document.getElementById('ilceFilter').addEventListener('change', applyAllFilters);
        document.getElementById('clearFiltersButton').addEventListener('click', clearAll);


        // Pop-up Fonksiyonu ve TÄ±klama (DeÄŸiÅŸiklik yok)
        function showPopup(feature) {
            const coords = feature.geometry.coordinates.slice(); const props = feature.properties; 
            let html = `<div class="popup-container">`;
            html += `<div class="popup-title">TaÅŸÄ±nmaz Bilgisi</div>`;
            if (props.Tapu_Sicil) html += `<strong>Tapu Sicil:</strong> ${props.Tapu_Sicil}<br>`;
            if (props.KN_No) html += `<strong>KN No:</strong> ${props.KN_No}<br>`;
            if (props.Ä°l_AdÄ±) html += `<strong>Ä°l/Ä°lÃ§e:</strong> ${props.Ä°l_AdÄ±} / ${props.Ä°lÃ§e_AdÄ±}<br>`;
            if (props.Mahalle) html += `<strong>Mahalle:</strong> ${props.Mahalle}<br>`;
            if (props.Ada) html += `<strong>Ada/Parsel:</strong> ${props.Ada} / ${props.Parsel}<br>`;
            if (props['KullanÄ±m_NiteliÄŸi_TanÄ±mÄ±']) html += `<strong>Nitelik:</strong> ${props['KullanÄ±m_NiteliÄŸi_TanÄ±mÄ±']}<br>`;
            if (props.FiltreGrubu) html += `<strong>Grup:</strong> ${props.FiltreGrubu}<br>`;
            if (props.YÃ¼z_Ã–lÃ§Ã¼m) html += `<strong>YÃ¼z Ã–lÃ§Ã¼m:</strong> ${props.YÃ¼z_Ã–lÃ§Ã¼m} mÂ²<br>`;
            html += `<hr><strong>Konum:</strong><br>${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
            html += `</div>`;
            if (currentPopup) {
                currentPopup.remove();
            }
            currentPopup = new maplibregl.Popup({ closeOnClick: true, maxWidth: '240px' })
                .setLngLat(coords)
                .setHTML(html)
                .addTo(map);
        }
        map.on('click', 'tasinmazlar-layer', (e) => { showPopup(e.features[0]); });
        
        // Arama FonksiyonlarÄ± (DeÄŸiÅŸiklik yok)
        function findAndFly(result) {
            if (result) {
                clearAll(); 
                map.flyTo({ center: result.geometry.coordinates, zoom: 17, speed: 1.5 });
                showPopup(result);
            } else {
                alert('TaÅŸÄ±nmaz bulunamadÄ±.\nLÃ¼tfen tam ve doÄŸru bir deÄŸer girin.');
            }
        }
        document.getElementById('tapuSearchButton').addEventListener('click', () => {
            const searchTerm = document.getElementById('tapuInput').value.trim();
            if (!searchTerm) return;
            const result = allPoints.find(feature => {
                 return String(feature.properties.Tapu_Sicil).trim() === searchTerm;
            });
            findAndFly(result);
        });
        document.getElementById('adaParselSearchButton').addEventListener('click', () => {
            const adaTerm = document.getElementById('adaInput').value.trim();
            const parselTerm = document.getElementById('parselInput').value.trim();
            if (!adaTerm || !parselTerm) { alert('LÃ¼tfen hem Ada hem de Parsel numarasÄ±nÄ± girin.'); return; }
            const result = allPoints.find(feature => {
                const propAda = String(feature.properties.Ada).trim();
                const propParsel = String(feature.properties.Parsel).trim();
                return propAda === adaTerm && propParsel === parselTerm;
            });
            findAndFly(result);
        });

        // Cursor (Fare Ä°mla) (DeÄŸiÅŸiklik yok)
        map.on('mouseenter', 'tasinmazlar-layer', () => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', 'tasinmazlar-layer', () => { map.getCanvas().style.cursor = ''; });
    </script>
</body>
</html>
