<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network - Kurum TaÅŸÄ±nmazlarÄ± AÄŸÄ±</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        /* ... (TÃ¼m <style> iÃ§eriÄŸi Ã¶ncekiyle aynÄ±) ... */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .header { position: absolute; top: 20px; left: 20px; background: rgba(255, 255, 255, 0.95); padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1; max-width: 350px; }
        .header h1 { margin: 0 0 10px 0; font-size: 24px; color: #e74c3c; }
        .header .day { display: inline-block; background: #e74c3c; color: white; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-bottom: 10px; }
        .header p { margin: 5px 0; font-size: 14px; color: #555; line-height: 1.5; }
        .stats { position: absolute; bottom: 20px; left: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1; font-size: 14px; }
        .stats-row { display: flex; justify-content: space-between; margin: 5px 0; gap: 20px; }
        .stats-label { color: #666; font-weight: 500; }
        .stats-value { color: #e74c3c; font-weight: bold; font-size: 16px; }
        .legend { position: absolute; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1; font-size: 13px; max-width: 280px; }
        .legend h3 { margin: 0 0 10px 0; font-size: 14px; color: #333; border-bottom: 2px solid #e74c3c; padding-bottom: 5px; }
        .legend-item { display: flex; align-items: center; margin: 8px 0; }
        .legend-color { width: 30px; height: 3px; margin-right: 10px; border-radius: 2px; }
        .legend-label { color: #666; }
        .controls { position: absolute; bottom: 20px; right: 20px; background: rgba(255, 255, 255, 0.95); padding: 15px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); z-index: 1; }
        .control-group { margin: 10px 0; }
        .control-label { font-size: 12px; color: #666; margin-bottom: 5px; display: block; }
        input[type="range"] { width: 200px; }
        select { width: 100%; padding: 8px 5px; border-radius: 5px; border: 1px solid #ccc; background-color: white; font-size: 13px; max-width: 200px; }
        .control-value { display: inline-block; margin-left: 10px; font-weight: bold; color: #e74c3c; min-width: 40px; }
        button { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 13px; margin: 5px 0; width: 100%; }
        button:hover { background: #c0392b; }
        .maplibregl-popup-content { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; box-shadow: 0 2px 10px rgba(0,0,0,0.15); border-radius: 8px; padding: 12px; }
        .popup-container { min-width: 220px; max-height: 250px; overflow-y: auto; font-size: 13px; }
        .popup-container strong { color: #333; font-size: 12px; }
        .popup-container hr { border: none; height: 1px; background: #eee; margin: 6px 0; }
        .popup-title { font-size: 16px; font-weight: 600; color: #e74c3c; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="header">
        <div class="day">AÅAMA 2</div>
        <h1>TaÅŸÄ±nmaz AÄŸÄ± HaritasÄ±</h1>
        <p>Kurumun <strong>~7,000</strong> taÅŸÄ±nmaz noktasÄ± arasÄ±ndaki baÄŸlantÄ± aÄŸÄ±.</p>
        <p style="font-size: 12px; color: #888; margin-top: 10px;">
            ğŸ–±ï¸ Harita Ã¼zerinde gezinin - mouse konumuna gÃ¶re taÅŸÄ±nmazlar arasÄ± Ã¶rÃ¼mcek aÄŸÄ± oluÅŸur.
        </p>
        <p style="font-size: 11px; color: #999; margin-top: 8px; border-top: 1px solid #eee; padding-top: 8px;">
            <strong>Veri KaynaÄŸÄ±:</strong><br>
            Kurum TaÅŸÄ±nmazlarÄ± Verisi (GeoJSON)
        </p>
    </div>
    <div class="stats">
        <div class="stats-row">
            <span class="stats-label">Aktif BaÄŸlantÄ±:</span>
            <span class="stats-value" id="connectionCount">0</span>
        </div>
        <div class="stats-row">
            <span class="stats-label">En YakÄ±n TaÅŸÄ±nmaz:</span>
            <span class="stats-value" id="nearestDistance">-</span>
        </div>
    </div>
    <div class="legend">
        <h3>BaÄŸlantÄ± Mesafesi</h3>
        <div class="legend-item"><div class="legend-color" style="background: #27ae60; opacity: 0.9;"></div><span class="legend-label">0-500m</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #f39c12; opacity: 0.8;"></div><span class="legend-label">500m-1km</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #e67e22; opacity: 0.7;"></div><span class="legend-label">1-2km</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #e74c3c; opacity: 0.5;"></div><span class="legend-label">2-3km</span></div>
        <div class="legend-item"><div class="legend-color" style="background: #c0392b; opacity: 0.3;"></div><span class="legend-label">3km+</span></div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label class="control-label">TaÅŸÄ±nmaz Grubu Filtresi</label>
            <select id="filterGroupSelect">
                <option value="TÃœMÃœ">TÃœMÃœ GÃ–STER</option>
                <option value="ARSA">ARSA</option>
                <option value="TARLA">TARLA</option>
                <option value="KONUT">KONUT</option>
                <option value="Ä°ÅYERÄ°">Ä°ÅYERÄ°</option>
                <option value="DÄ°ÄER">DÄ°ÄER</option>
            </select>
        </div>
        <div class="control-group">
            <label class="control-label">Maksimum Mesafe</label>
            <input type="range" id="maxDistance" min="500" max="5000" step="100" value="3000">
            <span class="control-value" id="maxDistanceValue">3000m</span>
        </div>
        <div class="control-group">
            <label class="control-label">Maksimum TaÅŸÄ±nmaz</label>
            <input type="range" id="maxConnections" min="10" max="200" step="10" value="50">
            <span class="control-value" id="maxConnectionsValue">50</span>
        </div>
        <button id="toggleAnimation">Animasyonu Durdur</button>
    </div>

    <script>
        // SÄ±nÄ±flandÄ±rma Fonksiyonu (DeÄŸiÅŸiklik yok)
        function getFiltreGrubu(nitelik) {
            if (!nitelik) { return 'DÄ°ÄER'; }
            if (nitelik === 'ARSA') { return 'ARSA'; }
            if (nitelik === 'TARLA') { return 'TARLA'; }
            const konutGrubu = ['GELENEKSEL APARTMAN', 'GELENEKSEL DAÄ°RE', 'MÃœSTAKÄ°L KONUT'];
            if (konutGrubu.includes(nitelik)) { return 'KONUT'; }
            const isyeriGrubu = ['DÃœKKAN/MAÄAZA', 'Ä°ÅYERÄ°/BÃœRO', 'Ä°Å MERKEZÄ°/Ä°Å HANI'];
            if (isyeriGrubu.includes(nitelik)) { return 'Ä°ÅYERÄ°'; }
            return 'DÄ°ÄER';
        }

        // Initialize map
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: { 'carto-light': { type: 'raster', tiles: ['https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'], tileSize: 256, attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>' } },
                layers: [{ id: 'carto-light-layer', type: 'raster', source: 'carto-light', minzoom: 0, maxzoom: 22 }]
            },
            center: [35.0000, 39.0000],
            zoom: 6,
            pitch: 0
        });

        let allPoints = [];
        let filteredPoints = [];
        let mousePosition = null;
        let animationEnabled = true;
        let maxDistance = 3000;
        let maxConnections = 50;

        // Load points (taÅŸÄ±nmaz) data
        fetch('kurum_tasinmazlari.geojson')
            .then(response => response.json())
            .then(data => {
                
                // Veri Ã¶n iÅŸleme (SÄ±nÄ±flandÄ±rma) (DeÄŸiÅŸiklik yok)
                data.features.forEach(feature => {
                    const nitelik = feature.properties['KullanÄ±m_NiteliÄŸi_TanÄ±mÄ±'];
                    feature.properties.FiltreGrubu = getFiltreGrubu(nitelik);
                });

                allPoints = data.features;
                filteredPoints = data.features;
                console.log(`Loaded ${allPoints.length} points and classified them into 'FiltreGrubu'.`);
                
                map.on('load', () => {
                    map.addSource('tasinmazlar', {
                        type: 'geojson',
                        data: data 
                    });
                    map.addLayer({
                        id: 'tasinmazlar-layer', type: 'circle', source: 'tasinmazlar',
                        paint: { 'circle-radius': 3, 'circle-color': '#3498db', 'circle-opacity': 0.6, 'circle-stroke-width': 1, 'circle-stroke-color': '#2980b9', 'circle-stroke-opacity': 0.8 }
                    });
                    map.addSource('spider-lines', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
                    map.addLayer({ id: 'spider-lines-layer', type: 'line', source: 'spider-lines', paint: { 'line-width': ['get', 'width'], 'line-color': ['get', 'color'], 'line-opacity': ['get', 'opacity'] } });
                    map.addSource('mouse-point', { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
                    map.addLayer({ id: 'mouse-point-layer', type: 'circle', source: 'mouse-point', paint: { 'circle-radius': 8, 'circle-color': '#e74c3c', 'circle-opacity': 0.8, 'circle-stroke-width': 2, 'circle-stroke-color': '#ffffff', 'circle-stroke-opacity': 1 } });
                });
            });

        // calculateDistance ve getColorForDistance (DeÄŸiÅŸiklik yok)
        function calculateDistance(lon1, lat1, lon2, lat2) { const R = 6371e3; const Ï†1 = lat1 * Math.PI / 180; const Ï†2 = lat2 * Math.PI / 180; const Î”Ï† = (lat2 - lat1) * Math.PI / 180; const Î”Î» = (lon2 - lon1) * Math.PI / 180; const a = Math.sin(Î”Ï†/2) * Math.sin(Î”Ï†/2) + Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(Î”Î»/2) * Math.sin(Î”Î»/2); const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); return R * c; }
        function getColorForDistance(distance) { if (distance < 500) return { color: '#27ae60', opacity: 0.9, width: 2.5 }; if (distance < 1000) return { color: '#f39c12', opacity: 0.8, width: 2.0 }; if (distance < 2000) return { color: '#e67e22', opacity: 0.7, width: 1.5 }; if (distance < 3000) return { color: '#e74c3c', opacity: 0.5, width: 1.2 }; return { color: '#c0392b', opacity: 0.3, width: 1.0 }; }

        // === DÃœZELTME: 'latLng.lat' TYPO DÃœZELTÄ°LDÄ° ===
        function updateSpider(lngLat) {
            if (!map.getSource('spider-lines')) return; 
            if (filteredPoints.length === 0) {
                document.getElementById('connectionCount').textContent = '0';
                document.getElementById('nearestDistance').textContent = '-';
                map.getSource('spider-lines').setData({ type: 'FeatureCollection', features: [] });
                return;
            }
            
            const mouseLon = lngLat.lng;
            const mouseLat = lngLat.lat; // <-- HATA BURADAYDI, 'latLng' -> 'lngLat' OLARAK DÃœZELTÄ°LDÄ°
            
            const pointsWithDistance = filteredPoints.map(point => {
                const [lon, lat] = point.geometry.coordinates;
                const distance = calculateDistance(mouseLon, mouseLat, lon, lat);
                return { point, distance }; 
            });
            const nearestPoints = pointsWithDistance.filter(item => item.distance <= maxDistance).sort((a, b) => a.distance - b.distance).slice(0, maxConnections);
            document.getElementById('connectionCount').textContent = nearestPoints.length;
            if (nearestPoints.length > 0) {
                const nearest = nearestPoints[0].distance;
                document.getElementById('nearestDistance').textContent = nearest < 1000 ? `${Math.round(nearest)}m` : `${(nearest/1000).toFixed(2)}km`;
            } else { document.getElementById('nearestDistance').textContent = '-'; }
            const lineFeatures = nearestPoints.map(item => {
                const [lon, lat] = item.point.geometry.coordinates; const style = getColorForDistance(item.distance);
                return { type: 'Feature', properties: { distance: item.distance, color: style.color, opacity: style.opacity, width: style.width }, geometry: { type: 'LineString', coordinates: [ [mouseLon, mouseLat], [lon, lat] ] } };
            });
            map.getSource('spider-lines').setData({ type: 'FeatureCollection', features: lineFeatures });
            map.getSource('mouse-point').setData({ type: 'FeatureCollection', features: [{ type: 'Feature', geometry: { type: 'Point', coordinates: [mouseLon, mouseLat] } }] });
        }

        // Mouse move handler (AnlÄ±k tepki, deÄŸiÅŸiklik yok)
        map.on('mousemove', (e) => {
            if (animationEnabled) { mousePosition = e.lngLat; updateSpider(e.lngLat); }
        });
        map.on('mouseleave', () => {
            if (map.getSource('spider-lines')) { map.getSource('spider-lines').setData({ type: 'FeatureCollection', features: [] }); }
            if (map.getSource('mouse-point')) { map.getSource('mouse-point').setData({ type: 'FeatureCollection', features: [] }); }
            document.getElementById('connectionCount').textContent = '0';
            document.getElementById('nearestDistance').textContent = '-';
        });

        // Controls (KaydÄ±raÃ§lar) (AnlÄ±k tepki, deÄŸiÅŸiklik yok)
        document.getElementById('maxDistance').addEventListener('input', (e) => {
            maxDistance = parseInt(e.target.value);
            document.getElementById('maxDistanceValue').textContent = `${maxDistance}m`;
            if (mousePosition && animationEnabled) { updateSpider(mousePosition); }
        });
        document.getElementById('maxConnections').addEventListener('input', (e) => {
            maxConnections = parseInt(e.target.value);
            document.getElementById('maxConnectionsValue').textContent = maxConnections;
            if (mousePosition && animationEnabled) { updateSpider(mousePosition); }
        });
        document.getElementById('toggleAnimation').addEventListener('click', () => {
            animationEnabled = !animationEnabled;
            const btn = document.getElementById('toggleAnimation');
            btn.textContent = animationEnabled ? 'Animasyonu Durdur' : 'Animasyonu BaÅŸlat';
            if (!animationEnabled) {
                map.getSource('spider-lines').setData({ type: 'FeatureCollection', features: [] });
                map.getSource('mouse-point').setData({ type: 'FeatureCollection', features: [] });
            } else if (mousePosition) { updateSpider(mousePosition); }
        });


        // Filtre Dinleyicisi (SÄ±nÄ±flandÄ±rma mantÄ±ÄŸÄ±na gÃ¶re gÃ¼ncellendi)
        document.getElementById('filterGroupSelect').addEventListener('change', (e) => {
            const selectedGroup = e.target.value;
            
            if (selectedGroup === 'TÃœMÃœ') {
                map.setFilter('tasinmazlar-layer', null);
                filteredPoints = allPoints;
            } else {
                map.setFilter('tasinmazlar-layer', ['==', ['get', 'FiltreGrubu'], selectedGroup]);
                filteredPoints = allPoints.filter(feature => {
                    return feature.properties.FiltreGrubu === selectedGroup;
                });
            }
            if (mousePosition && animationEnabled) {
                updateSpider(mousePosition);
            }
        });


        // Pop-up (AÃ§Ä±lÄ±r Pencere) (Biraz gÃ¼ncellendi)
        map.on('click', 'tasinmazlar-layer', (e) => {
            const feature = e.features[0]; const coords = feature.geometry.coordinates.slice(); const props = feature.properties; 
            let html = `<div class="popup-container">`;
            html += `<div class="popup-title">TaÅŸÄ±nmaz Bilgisi</div>`;
            if (props.Tapu_Sicil) html += `<strong>Tapu Sicil:</strong> ${props.Tapu_Sicil}<br>`;
            if (props.KN_No) html += `<strong>KN No:</strong> ${props.KN_No}<br>`;
            if (props.Ä°l_AdÄ±) html += `<strong>Ä°l/Ä°lÃ§e:</strong> ${props.Ä°l_AdÄ±} / ${props.Ä°lÃ§e_AdÄ±}<br>`;
            if (props.Mahalle) html += `<strong>Mahalle:</strong> ${props.Mahalle}<br>`;
            if (props.Ada) html += `<strong>Ada/Parsel:</strong> ${props.Ada} / ${props.Parsel}<br>`;
            
            // Pop-up'a hem ham veriyi hem de sÄ±nÄ±flandÄ±rdÄ±ÄŸÄ±mÄ±z grubu ekleyelim:
            if (props['KullanÄ±m_NiteliÄŸi_TanÄ±mÄ±']) html += `<strong>Nitelik:</strong> ${props['KullanÄ±m_NiteliÄŸi_TanÄ±mÄ±']}<br>`;
            if (props.FiltreGrubu) html += `<strong>Grup:</strong> ${props.FiltreGrubu}<br>`;

            if (props.YÃ¼z_Ã–lÃ§Ã¼m) html += `<strong>YÃ¼z Ã–lÃ§Ã¼m:</strong> ${props.YÃ¼z_Ã–lÃ§Ã¼m} mÂ²<br>`;
            html += `<hr><strong>Konum:</strong><br>${coords[1].toFixed(6)}, ${coords[0].toFixed(6)}`;
            html += `</div>`;
            new maplibregl.Popup({ closeOnClick: true, maxWidth: '240px' }).setLngLat(coords).setHTML(html).addTo(map);
        });

        // Cursor (Fare Ä°mla) (DeÄŸiÅŸiklik yok)
        map.on('mouseenter', 'tasinmazlar-layer', () => { map.getCanvas().style.cursor = 'pointer'; });
        map.on('mouseleave', 'tasinmazlar-layer', () => { map.getCanvas().style.cursor = ''; });
    </script>
</body>
</html>
